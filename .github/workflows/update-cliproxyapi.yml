name: Update CLIProxyAPI

on:
  schedule:
    - cron: '0 8 * * *' # Runs at 08:00 UTC every day
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: update-cliproxyapi
  cancel-in-progress: true

jobs:
  update-cliproxyapi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest CLIProxyAPI release
        id: get-latest-release
        run: |
          set -e
          LATEST_JSON=$(curl -s -f https://api.github.com/repos/router-for-me/CLIProxyAPI/releases/latest)
          
          if [ -z "$LATEST_JSON" ]; then
            echo "Error: Failed to fetch latest release JSON" >&2
            exit 1
          fi

          # Ensure pure JSON by stripping potential non-printable characters if any
          LATEST_TAG=$(echo "$LATEST_JSON" | tr -d '\000-\037' | jq -r .tag_name)
          
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "Error: Failed to extract tag_name from JSON" >&2
            exit 1
          fi

          VERSION=${LATEST_TAG#v}
          
          if [ -z "$VERSION" ]; then
            echo "Error: Version string is empty" >&2
            exit 1
          fi

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found latest version: $VERSION"

      - name: Download and Install CLIProxyAPI
        run: |
          set -e
          VERSION="${{ steps.get-latest-release.outputs.version }}"
          TAG="${{ steps.get-latest-release.outputs.latest_tag }}"
          FILENAME="CLIProxyAPI_${VERSION}_darwin_arm64.tar.gz"
          URL="https://github.com/router-for-me/CLIProxyAPI/releases/download/$TAG/$FILENAME"
          TARGET_DIR="src/Sources/Resources"
          TARGET_FILE="$TARGET_DIR/cli-proxy-api"
          
          echo "Downloading $URL..."
          if ! wget -q -O "$FILENAME" "$URL"; then
            echo "Error: Failed to download $URL" >&2
            exit 1
          fi
          
          if [ ! -s "$FILENAME" ]; then
             echo "Error: Downloaded file is empty" >&2
             exit 1
          fi
          
          echo "Validating tarball..."
          if ! tar -tzf "$FILENAME" > /dev/null; then
             echo "Error: Invalid tarball" >&2
             exit 1
          fi
          
          echo "Extracting..."
          tar -xzf "$FILENAME"
          
          # Find the binary file (exclude LICENSE, README, and other docs)
          # Look for files in the tarball that don't have common documentation extensions
          EXTRACTED_FILE=$(tar -tf "$FILENAME" | grep -v -E '(LICENSE|README|\.md$|\.txt$)' | head -n 1)
          
          if [ -z "$EXTRACTED_FILE" ]; then
             echo "Error: Could not find binary in tarball" >&2
             echo "Tarball contents:" >&2
             tar -tf "$FILENAME" >&2
             exit 1
          fi
          
          echo "Found binary: $EXTRACTED_FILE"
          
          if [ ! -f "$EXTRACTED_FILE" ]; then
             echo "Error: Extraction failed, $EXTRACTED_FILE not found" >&2
             exit 1
          fi
          
          echo "Creating target directory..."
          mkdir -p "$TARGET_DIR"
          
          echo "Moving $EXTRACTED_FILE to $TARGET_FILE"
          mv "$EXTRACTED_FILE" "$TARGET_FILE"
          
          if [ ! -f "$TARGET_FILE" ]; then
             echo "Error: Failed to move file to $TARGET_FILE" >&2
             exit 1
          fi
          
          if [ ! -s "$TARGET_FILE" ]; then
             echo "Error: Target file is empty" >&2
             exit 1
          fi

          chmod +x "$TARGET_FILE"
          rm -f "$FILENAME"
          
          echo "Verifying binary..."
          if ! "$TARGET_FILE" --version; then
             echo "Error: Binary verification failed" >&2
             exit 1
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Bump CLIProxyAPI to ${{ steps.get-latest-release.outputs.version }}
          title: Bump CLIProxyAPI to ${{ steps.get-latest-release.outputs.version }}
          body: |
            Updates bundled CLIProxyAPI to version [${{ steps.get-latest-release.outputs.version }}](https://github.com/router-for-me/CLIProxyAPI/releases/tag/${{ steps.get-latest-release.outputs.latest_tag }}).
            
            This PR was automatically generated by the Update CLIProxyAPI workflow.
          branch: bump-cliproxyapi-${{ steps.get-latest-release.outputs.version }}
          delete-branch: true
